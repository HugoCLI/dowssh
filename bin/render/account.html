<!DOCTYPE html>
<html>
<head>
    <title>Dowssh</title>
    <link href="assets/styles/base.css" rel="stylesheet">
    <link href="assets/styles/header.css" rel="stylesheet">

    <link href="assets/fonts/Ubuntu.css" rel="stylesheet">
    <link href="assets/fonts/boxicons/css/boxicons.min.css" rel="stylesheet">
</head>
<body>
<style>

    * {
        user-select: none;
    }

    .contains {
        margin: 25px;

    }


    .loader {
        align-items: center;
        position: absolute;
        top: 0;
        flex-direction: column;
        bottom: 0;
        left: 0;
        display: flex;
        z-index: 999999999;
        right: 0;
        background: #edf1f2;
        justify-content: center;
    }

    .loader h2 {
        font-weight: 300;
        font-size: 25px;
    }

    .loader h2 span {
        font-weight: 500;
    }


    .loader-animation {
        display: flex;
        flex-direction: column;
        height: 200px;
        width: 100%;
        justify-content: center;
        align-items: center;
    }

    .loader-animation span {
        position: absolute;
        width: 50px;
        height: 50px;
        border-radius: 100px;
        border: 3px solid #009BFF;
        animation: loader 2s infinite;
    }

    .loader-animation span:nth-child(1) {
        animation-delay: -0.99s
    }

    .loader-animation span:nth-child(2) {
        animation-delay: -0.66s
    }

    .loader-animation span:nth-child(3) {
        animation-delay: -0.33s
    }

    @keyframes loader {
        0% {
            transform: scale(0);
            z-index: 3;
            opacity: 1;
        }
        50% {
            transform: scale(2);
            z-index: 2;
        }
        75% {
            transform: scale(2);

        }
        100% {
            opacity: 0;
            transform: scale(0);
            z-index: 0;
        }
    }

    .ent {
        display: flex;
        flex-direction: column;
        height: 200px;
        margin-top:25px;
        justify-content: flex-end;
        align-items: center;
    }

    .ent img.profile {
        border-radius: 100px;
        width: 100px;
        height: 100px;
        margin-bottom: 25Px;
        object-fit: cover;
        box-shadow: rgba(67, 71, 85, 0.27) 0px 0px 0.25em, rgba(90, 125, 188, 0.05) 0px 0.25em 1em;
    }

    .sync {
        background: #E8E8E8;
        margin-top: 50px;
        padding: 15px 25px;
        display: grid;
        grid-template-columns: 50px calc(100% - 50px);
        width: 100%;
        align-items: center;
    }

    .sync h4 {
        color: #141236;
        font-weight: 500;
        font-size: 15px;
    }

    .sync p {
        color: #505050;
        font-weight: 400;
        margin-top: 5px;
        font-size: 14px;
    }

    .sync i {
        font-size: 20px
    }

    .hide {
        display: none;
    }

    .login {
        padding: 30px;
    }

    .login .btn {
        padding: 10px;
        background: #fff;
        cursor: pointer;
        display: flex;
        box-shadow: rgba(67, 71, 85, 0.27) 0px 0px 0.25em, rgba(90, 125, 188, 0.05) 0px 0.25em 1em;
        border-radius: 7px;
        align-items: center;
        justify-content: center;
        color: #141236;
        margin-bottom: 10px;
        font-size: 14px;
        transition: 250ms;
        font-weight: 600;
    }

    .login .btn:hover {
        transform: scale(1.05)
    }

    .login .btn img {
        margin-right: 10px;
        height: 32px;
        width: 32px;
        display: inline-flex;
    }

    .login p {
        margin-top: 5px;
    }

    .account {
        padding: 30px;
    }

    .account .item {
        margin-bottom: 30px;
    }

    .account h5 {
        font-size: 14px;
    }

    .account h2 {
        font-weight: 400;
        font-size: 15px;
        margin-top: 5px;
    }

    .config {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background: #202020;
        z-index: 999999999;
    }

    .config .checking {
        display: flex;
        height: 125px;
        margin-top: 25px;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        padding: 55px;
    }

    .config .checking h2 {
        color: #eeee;
        text-align: center;
        line-height: 1.25em;
        font-size: 25px;
        font-weight: 400;
        margin-top: 25px;
    }

    .config .checking i {
        color: #fc2e57;
        font-size: 40px;
    }

    .config .acc {
        display: grid;
        grid-template-columns: 100px calc(100% - 100px);
        background: #252525;
        padding: 27px 30px;
        justify-content: center;
    }

    .config .acc div:nth-child(1) {
        display:flex;
        justify-content: center;
    }

    .config .acc h3 {
        color: #eee;
        font-size: 15px;
        font-weight: 500;
    }

    .config .acc p {
        color: #858585;
        font-size: 14px;
        margin-top: 5px;
        font-weight: 500;
    }

    .config .acc img {
        width: 40px;
        height: 40px;
        border-radius: 100px;
        object-fit: cover;
    }

    .config label {
        background: #202020;
        color: #ccc;
    }

    .config .input {
        margin-top: 20px;

        padding: 20px;
    }

    .config .input .info, .config .input .error {
        margin-bottom:20px;
        margin-top:-10px;
        justify-content: center;
        display:grid;
        line-height: 1.5em;
        background: rgba(48, 48, 48, 0.30);
        color:#bbb;
        grid-template-columns: 25px calc(100% - 25px);
        border:1px solid rgba(255, 255, 255, 0.05);
        border-radius: 7px;
        padding:15px;
        font-weight: 500;
        font-size:12px;
    }
    .config .input .error {
        background:rgba(202, 45, 45, 0.25);
        border:1px solid rgba(202, 45, 45, 1);
    }

    .config .input .info p,  .config .input .error p {
        margin-top: -2px;
    }

    .config .input .confirmer {
        width:100%;
        display:flex;
        padding:15px;
        background:#252525;
        color:#aaa;
        justify-content: center;
        align-items: center;
        border: none;
        border-radius: 7px;
        transition: 250ms;
    }

    .config .input .confirmer.enabled {
        background:#009BFF !important;
        color:#fff;
    }


    .config .input .confirmer.enabled:hover {
        transform:scale(1.05);
        cursor: pointer;

    }

    .account-action {
        height: 65px;
        overflow: hidden;
        transition: 250ms;
        position: absolute;
        margin-left: 20px;
        left: 0;
        top: 0;
        z-index: 99999;
        -webkit-user-select: none;
        -webkit-app-region: drag;
        justify-content: flex-end;
        align-items: center;
        display: flex;
    }

    .account-action  div {
        display: inline-grid;
        padding: 0 15px;
        -webkit-app-region: no-drag;
        height: 100%;
        border-radius: 7px;
        align-items: center;
        transition: 250ms;
    }

    .account-action  div:hover {
        transform:scale(1.5);
    }

    .account-action i {
        color: #000000;
        font-size: 16px;
    }

    .device-alert {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background: #202020;
        z-index: 999999997;
    }
    .device-alert {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background: #202020;
        z-index: 999999999;
    }

    .device-alert .checking {
        display: flex;
        height: 100vh;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        padding: 55px;
    }

    .device-alert .checking h2 {
        color: #eeee;
        text-align: center;
        line-height: 1.5em;
        font-size: 25px;
        font-weight: 500;
        margin-top: 25px;
    }

    .device-alert .checking i {
        color: #009BFF;
        font-size: 40px;
    }

    .device-alert .acc {
        display: grid;
        grid-template-columns: 100px calc(100% - 100px);
        background: #252525;
        padding: 27px 30px;
        justify-content: center;
    }

    .device-alert .acc div:nth-child(1) {
        display:flex;
        justify-content: center;
    }

    .device-alert .acc h3 {
        color: #eee;
        font-size: 15px;
        font-weight: 500;
    }

    .device-alert .acc p {
        color: #858585;
        font-size: 14px;
        margin-top: 5px;
        font-weight: 500;
    }

    .device-alert .acc img {
        width: 40px;
        height: 40px;
        border-radius: 100px;
        object-fit: cover;
    }


    .device-alert .input {
        margin-top: 20px;

        padding: 20px;
    }

    .device-alert .input .info, .device-alert .input .error {
        margin-bottom:20px;
        margin-top:-10px;
        justify-content: center;
        display:grid;
        line-height: 1.5em;
        background: rgba(48, 48, 48, 0.30);
        color:#bbb;
        grid-template-columns: 25px calc(100% - 25px);
        border:1px solid rgba(255, 255, 255, 0.05);
        border-radius: 7px;
        padding:15px;
        font-weight: 500;
        font-size:12px;
    }
    .device-alert .input .error {
        background:rgba(202, 45, 45, 0.25);
        border:1px solid rgba(202, 45, 45, 1);
    }

    .device-alert .device {
        background: #272727;
        padding: 30px;
        display: grid;
        grid-template-columns: 60px calc(100% - 60px);
        align-items: center;
    }

    .device-alert .device_name {
        color:#fff;
        font-weight: 700;
        font-size:17px;
    }

    .device-alert .device_loc {
        color:#ccc;
        font-weight: 400;
        margin-top:10px;
        font-size:19px;
    }

    .device-alert  p {
        color:#858585;
        font-weight: 500;
        margin-top: 30px;
        font-size:15px;
    }

    .device-alert .device i {
        color:#009BFF;
        font-size:28px
    }



</style>
<div class="contains">
    <div class="account-action">
        <div action="display-device">
            <i class='bx bx-devices' ></i>
        </div>
    </div>
    <div class="header">
        <div action="window-close">
            <i class='bx bx-x'></i>
        </div>
    </div>
    <div class="device-alert hide">

        <div class="checking">
            <i class='bx bxl-windows' ></i>
            <h2>DESKTOP-QMKBDP2</h2>
            <div class="device_loc">Cugnaux (Occitanie) — France</div>
            <p>Windows • 91.170.22.198</p>
        </div>
<!--        <div class="input">-->
<!--            <div class="info">-->
<!--                <div>-->
<!--                    <i class='bx bx-info-circle'></i>-->
<!--                </div>-->
<!--                <div>-->
<!--                    <p>Alerte émise par le serveur Dowssh-Germany-1</p>-->
<!--                </div>-->
<!--            </div>-->

<!--        </div>-->


    </div>
    <div class="config hide">
        <div class="acc">
            <div>
                <img src="">
            </div>
            <div>
                <h3></h3>
                <p></p>
            </div>

        </div>
        <div class="checking">
            <h2>Une action sur votre compte est requise</h2>
        </div>
        <div class="input">
            <label>Créer un mot de passe</label>
            <input id="passphrase-password" placeholder="Veuillez saisir un mot de passe" type="password">
            <div class="info">
                <div>
                    <i class='bx bx-info-circle'></i>
                </div>
                <div>
                    <p>Ce mot de passe est essentiel à la sécurité de vos données, il vous sera demandé à chaque connexion.</p>
                </div>
            </div>
            <div class="error">
                <div>
                    <i class='bx bx-error'></i>
                </div>
                <div>
                    <p>En cas de perte de celui-ci, vous ne pourrez pas récupérer les données.</p>
                </div>
            </div>


            <button class="confirmer disabled">Confirmer</button>
        </div>


    </div>
    <div class="ent">
        <img class="profile hide" src="">
        <h2 class="welcome-message">Salut 👋</h2>
    </div>
    <div class="sync">
        <div class="icon">
            <i class='bx bx-message-error'></i>
        </div>
        <div>
            <h4>Vous n'êtes pas connecté</h4>
            <p>La sauvegarde sur le nuage est désactivée</p>
        </div>
    </div>
    <div class="login">
        <div class="btn" connect="google">
            <img src="https://www.google.com/favicon.ico"> Se connecter à Google
        </div>
        <!--        <div class="btn" connect="github">-->
        <!--            <img src="https://github.com/favicon.ico"> Se connecter à GitHub-->
        <!--        </div>-->

    </div>
    <div class="account hide">
        <div class="item" form="email">
            <h5>Adresse e-mail <span>(Vérifié par Google)</span></h5>
            <h2></h2>
        </div>
        <div class="item" form="identity">
            <h5>Mes informations</h5>
            <h2></h2>
        </div>
    </div>
    <div class="loader">
        <div class="loader-animation">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <h2></h2>
    </div>
</div>
<script>
    const doc = document;
    const CONTAINS = doc.querySelector('.contains').innerHTML;
    let websocket = null;
    let sync = false;
    const {ipcRenderer} = require('electron');
    const sendData = (type, value) => ipcRenderer.send(type, value);


    ipcRenderer.send('onready', 'account');
    ipcRenderer.send('api:get-account', 'account');
    ipcRenderer.send('api:get-status');

    ipcRenderer.on('api:get-account', async (event, data) => {
        if (!data) return doc.querySelector('.loader').style.display = "none";
        displayAccount(data);
    });


    ipcRenderer.on('request-passphrase', async (event, data) => {
        doc.querySelector('.config').classList.remove('hide');
    })


    const displayAccount = async (data) => {
        if(!data) return doc.querySelector('.contains').innerHTML = CONTAINS;
        doc.querySelector('.loader').style.display = "none";
        doc.querySelector('.login').style.display = "none";
        doc.querySelector('.ent .welcome-message').innerText = "Hey " + data.fn + " 👋";
        if (data.picture) {
            doc.querySelector('.config .acc img').setAttribute('src', data.picture);
            doc.querySelector('.device-alert .acc img').setAttribute('src', data.picture);
            doc.querySelector('img.profile').setAttribute('src', data.picture);
            doc.querySelector('img.profile').classList.remove('hide');
        }
        doc.querySelector('.sync h4').innerText = "Préparation de synchronisation";
        doc.querySelector('.sync p').innerText = "Chargement de l'autorité de synchronisation";
        doc.querySelector('.sync .icon').innerHTML = "<i class='bx bx-sync bx-spin' ></i>";


        doc.querySelector('.account').classList.remove('hide');
        doc.querySelectorAll('.account .item').forEach((e) => {
            const data_type = e.getAttribute('form');
            if (data_type === "email")
                doc.querySelector('.device-alert .acc p').innerText = data[data_type];
                doc.querySelector('.config .acc p').innerText = data[data_type];
            if (data.email_verified) doc.querySelector('.account .item[form="' + data_type + '"] h5 span').classList.remove('hide')
            if (data_type === "identity") {
                let identity = data.fn + " " + data.ln;
                if (data.ln === undefined) identity = data.fn;
                doc.querySelector('.config .acc h3').innerText = identity;
                doc.querySelector('.device-alert .acc h3').innerText = identity;
                return doc.querySelector('.account .item[form="' + data_type + '"] h2').innerText = identity;
            }
            doc.querySelector('.account .item[form="' + data_type + '"] h2').innerText = data[data_type];

        })
        ipcRenderer.send('api:get-sync-status');
        doc.querySelector('.loader').classList.add('hide');

    }


    doc.querySelectorAll('.btn[connect]').forEach(async (e) => {
        e.addEventListener('click', async (ev) => {
            sendData('api:open-link', e.getAttribute('connect'));
        })
    })


    ipcRenderer.on('profiler-account-link-receive', async (event, data) => {
        doc.querySelector('.loader').style.display = "flex";
        if (data.data) return doc.querySelector('.loader h2').innerHTML = "En attente du serveur";
        doc.querySelector('.loader h2').innerHTML = "Veuillez patienter";

    })


    ipcRenderer.on('profiler-account-link-error', async (event, data) => {
        doc.querySelector('.loader').style.display = "none";
        alert('error auith');
    })


    ipcRenderer.on('profiler-sync', async (event, data) => {
        if (data === 3) {
            doc.querySelector('.sync h4').innerText = "Synchronisation en cours";
            doc.querySelector('.sync .icon').innerHTML = "<i class='bx bx-sync bx-spin' ></i>";
            doc.querySelector('.sync p').innerText = "Cela peut prendre plusieurs minutes";
        } else if(data === 2) {
            doc.querySelector('.sync h4').innerText = "Synchronisation terminée";
            doc.querySelector('.sync p').innerText = "Votre compte est à jour";
            doc.querySelector('.sync .icon').innerHTML = "<i class='bx bx-check' ></i>";
        } else if(data === 1) {
            doc.querySelector('.sync h4').innerText = "Attente de synchronisation";
            doc.querySelector('.sync p').innerText = "Cette opération peut durée plusieurs minutes";
            doc.querySelector('.sync .icon').innerHTML = "<i class='bx bx-sync bx-spin'></i>";
        } else  {
            doc.querySelector('.sync h4').innerText = "Vous n'êtes pas connecté";
            doc.querySelector('.sync p').innerText = "La sauvegarde sur le nuage est désactivé";
            doc.querySelector('.sync .icon').innerHTML = "<i class='bx bx-message-error'></i>";
        }
    });


    ipcRenderer.on('get-profile', async (event, data) => {
        displayAccount(data);
    })

    ipcRenderer.on('alert-system', async(event, data) => {
        doc.querySelector('.device-alert').classList.remove('hide');
    });

    doc.querySelector('[action="window-close"]').addEventListener('click', () => {
        sendData('window', {type: 'account', action: 'close'});
    })

    doc.querySelector("#passphrase-password").addEventListener('input', (e) =>  {
        if(doc.querySelector("#passphrase-password").value.length > 6)
            return doc.querySelector('.confirmer').classList.add('enabled');
        return doc.querySelector('.confirmer').classList.remove('enabled');
    });

    doc.querySelector('.confirmer').addEventListener('click', () => {
        const value = doc.querySelector("#passphrase-password").value;
        if(value.length > 6) {
            doc.querySelector('.loader').style.display = "flex";
            doc.querySelector('.config').classList.add('hide');

            ipcRenderer.send('api:set-settings', {type: 'passphrase', value: value});
        }
    })
    ipcRenderer.on('set-passphrase-callback', async (event, data) => {
        doc.querySelector('.loader').style.display = "none";
        doc.querySelector('.config').classList.add('hide');
    })


</script>
</body>
</html>